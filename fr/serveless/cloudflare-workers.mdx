---
title: "Envoyer avec Cloudflare Workers"
description: "Envoyez des SMS avec Rewrite depuis un Cloudflare Worker."
---

Ce guide montre comment envoyer des SMS avec Rewrite dans un **Cloudflare Worker**.

## 1. Installer le SDK

```bash
npm install @rewritejs/sdk
```

## 2. Configurer les variables d'environnement

Definissez votre cle API dans les secrets `wrangler.toml` :

```bash
wrangler secret put REWRITE_API_KEY
```

## 3. Creer le worker

```ts src/index.ts
import { Rewrite } from '@rewritejs/sdk';

export interface Env {
  REWRITE_API_KEY: string;
}

export default {
  async fetch(request: Request, env: Env): Promise<Response> {
    if (request.method !== 'POST') {
      return Response.json(
        {
          ok: false,
          code: 'METHOD_NOT_ALLOWED',
          message: 'Method not allowed.',
        },
        { status: 405 }
      );
    }

    const rewrite = new Rewrite(env.REWRITE_API_KEY);
    const body = await request.json().catch(() => ({}));
    const { to, message } = body as { to?: string; message?: string };

    if (!to || !message) {
      return Response.json(
        {
          ok: false,
          code: 'INVALID_REQUEST',
          message: '`to` and `message` are required.',
        },
        { status: 400 }
      );
    }

    const { data, error } = await rewrite.messages.send({
      to,
      message,
      metadata: { source: 'cloudflare-worker' },
    });

    if (error) {
      return Response.json(
        {
          ok: false,
          code: 'SMS_SEND_FAILED',
          message: 'Failed to send SMS.',
          errors: error,
        },
        { status: 422 }
      );
    }

    return Response.json({ ok: true, data }, { status: 200 });
  },
};
```

## 4. Tester en local

```bash
curl -X POST "http://127.0.0.1:8787" \
  -H "Content-Type: application/json" \
  -d '{
    "to": "+15551234567",
    "message": "Hello from Cloudflare + Rewrite"
  }'
```

## 5. Deployer

```bash
wrangler deploy
```

<Info>
Les Workers sont ideaux pour les envois edge a faible latence, mais vous devez tout de meme ajouter des retries et de l'idempotence dans votre couche applicative.
</Info>
